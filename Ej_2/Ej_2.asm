.INCLUDE "M328PDEF.INC"

.EQU TAMANIO_TABLA_RAM = 1000

.DSEG
.ORG 0x100

		TABLA_RAM: .BYTE TAMANIO_TABLA_RAM

.CSEG
.ORG 0x00
		
		RJMP main

.ORG INT_VECTORS_SIZE

main:	LDI R16, LOW(RAMEND)
		OUT SPL, R16
		LDI R16, HIGH(RAMEND)
		OUT SPH,R16
		SBI DDRB, PB1
		SBI DDRB, PB2
		RCALL CARGAR_TABLA
		RCALL PROCESAR_TABLA
		RJMP main




PROCESAR_TABLA:
		LDI XL, LOW(TABLA_RAM)
		LDI XH, HIGH(TABLA_RAM)
		
aca2:	LD R20, X+
		CPI R20, 0xFF
		BREQ salir
		RCALL CALCULA_PARIDAD
		RJMP aca2
salir:	RET


CALCULA_PARIDAD:
		LDI R16, 8
		CLR R21
		ADD R21, R20
		ANDI R21, 0x01
loop1:	ROR R20
		EOR R21, R20
		DEC R16
		BRNE loop1
		
		LDI R16, 8
loop2:	SBI PORTB, PB2
		RCALL DELAY
		CBI PORTB, PB2
		RCALL DELAY
		ROL R20
		BRCC aca3
		SBI PORTB, PB1
		RJMP aca4
aca3:	CBI PORTB, PB1
aca4:	DEC R16
		BRNE loop2
		SBI PORTB, PB2
		RCALL DELAY
		CBI PORTB, PB2
		RCALL DELAY
		ROR R21
		BRCC aca5
		SBI PORTB, PB1
aca5:	CBI PORTB, PB1
		RET



DELAY:
		NOP
		RET




CARGAR_TABLA:
		LDI XL, LOW(TABLA_RAM)
		LDI XH, HIGH(TABLA_RAM)
		LDI ZL, LOW(TABLA_ROM << 1)
		LDI ZH, HIGH(TABLA_ROM << 1)

loop3:	LPM R16, Z+
		ST X+, R16
		CPI R16, 0xFF
		BRNE loop3
		RET








TABLA_ROM: .DB 0X55,0X0F,0Xff
